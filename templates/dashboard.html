<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="navbar">
        <div>Welcome, {{ user }}</div>
        <div>
            <a href="{{ url_for('equipment') }}" style="color:white;margin-right:15px;">+ Add Equipment</a>
            <a href="{{ url_for('view_tickets') }}" style="color:white;margin-right:15px;">Tickets</a>
            {% if is_admin %}
            <a href="{{ url_for('admin_panel') }}" style="color:white;margin-right:15px;">Admin Panel</a>
            {% endif %}
            <a href="{{ url_for('logout') }}" style="color:white;">Logout</a>
        </div>
    </div>

    <div class="container">
        <h2>Equipment</h2>
        <input type="text" id="search-box" placeholder="Search equipment...">
        <div id="equipment-container">Loading...</div>
    <div class="comment-section">
        <h3>Comments</h3>
        <form method="POST" action="{{ url_for('add_comment') }}">
            <input type="hidden" name="equipment_id" value="{{ equipment.id }}">
            <textarea name="comment" placeholder="Add your note..." required></textarea>
            <button type="submit">Add Comment</button>
        </form>
        <div class="comments-list">
            {% for comment in equipment.comments %}
                <div class="comment">
                    <p>{{ comment.text }}</p>
                    <span class="timestamp">{{ comment.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
            {% endfor %}
        </div>
    </div>

    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- âœ… Retry logic goes here, just before </body> -->
    <script>
    (function autoRetryGatewayError() {
      const maxAttempts = 5;
      const delayBetweenAttempts = 5000;
      let attempts = 0;

      function checkStatus() {
        fetch(window.location.href, { cache: 'no-store' })
          .then(res => {
            if (!res.ok) throw new Error('Retrying due to bad response');
          })
          .catch(() => {
            if (attempts < maxAttempts) {
              attempts++;
              console.warn(`Retrying load (attempt ${attempts})...`);
              setTimeout(() => location.reload(), delayBetweenAttempts);
            } else {
              alert("Still having trouble loading the page.");
            }
          });
      }

      window.addEventListener('load', () => {
        setTimeout(checkStatus, 1500);
      });
    })();
    </script>
</body>
</html>
